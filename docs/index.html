<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
    <title>podcasts</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <h2>podcasts</h2>
        <div class="search-wrapper">
            <input type="text" id="searchInput" placeholder="Søg..">
            <span class="clear-search" onclick="clearSearch()">&#10006;</span>
        </div>
        <p class="helper-text">12/10 podcasts fra Radio 24syv er midlertidigt nede: https://x.com/internetarchive/</p>
        <div id="results"></div>
    </div>
    <div id="podcastModal" class="modal">
        <div class="modal-content">
            <div class="close" id="closeModal">&#10006</div>
            <h3 id="modalTitle">Titel</h3>
            <h3 id="modalProvider">Udgiver</h3>
            <div id="modalDescription">Beskrivelse</div>
            <div class="modal-icons">
                <a href="#" id="visitWebsiteLink" target="_blank" title="Besøg programmets hjemmeside" class="icon-link">
                    <i class="fas fa-globe"></i>
                </a>
                <a href="#" id="playOnSite" title="Afspil her" class="icon-link">
                    <i class="fas fa-play"></i>
                </a>
                <a id="copyRSSButton" title="Kopiér RSS-link" class="icon-link">
                    <i class="fas fa-rss"></i>
                </a>
                <a href="#" id="openInAppLink" title="Åbn i podcast-app" class="icon-link">
                    <i class="fas fa-podcast"></i>
                </a>
            </div>
        </div>
    </div>
<script>
const resultsContainer = document.getElementById('results');
const h2Container = document.querySelector('.container h2');
let drPodcastsData = [];
let podimoPodcastsData = [];
let miscPodcastsData = [];
let pir8dioPodcastsData = [];
let politikenPodcastsData = [];
let radio4PodcastsData = [];

document.addEventListener('DOMContentLoaded', () => {
    fetchDataAndPreloadIcon();
  
  document.getElementById('podcastModal').addEventListener('click', function(event) {
    const descriptionElement = document.getElementById('modalDescription');
    if (event.target === descriptionElement) {
        descriptionElement.classList.toggle('expanded');
    }
});
    
    window.onclick = function(event) {
        const modal = document.getElementById('podcastModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };

    const closeModalButton = document.getElementById('closeModal');
    closeModalButton.addEventListener('click', () => {
        const modal = document.getElementById('podcastModal');
        modal.style.display = 'none';
    });
});


async function fetchDataAndPreloadIcon() {
    try {
        [drPodcastsData, podimoPodcastsData, miscPodcastsData, pir8dioPodcastsData, politikenPodcastsData, radio4PodcastsData] = await Promise.all([
            fetchDRPodcastsData(),
            fetchPodimoPodcastsData(),
            fetchMiscPodcastsData(),
            fetchPir8dioPodcastsData(),
            fetchPolitikenPodcastsData(),
            fetchradio4PodcastsData(),
        ]);
    } catch (error) {
        console.error('Error fetching data:', error);
    }
}

async function fetchData(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Error fetching data from ${url}`);
        return await response.json();
    } catch (error) {
        console.error(`Error fetching data from ${url}:`, error);
        return null;
    }
}

async function fetchDRPodcastsData() {
    return fetchData('https://raw.githubusercontent.com/UmFzbXVz/DRSS/main/docs/drlyd.json');
}

async function fetchPodimoPodcastsData() {
    return fetchData('https://raw.githubusercontent.com/UmFzbXVz/podcasts/main/Podimo/docs/podimo.json');
}

async function fetchMiscPodcastsData() {
    return fetchData('https://raw.githubusercontent.com/UmFzbXVz/podcasts/main/misc/data.json');
}

async function fetchPir8dioPodcastsData() {
    return fetchData('https://raw.githubusercontent.com/UmFzbXVz/pir8dio/main/docs/oversigtAfsnit.json');
}

async function fetchPolitikenPodcastsData() {
    return fetchData('https://raw.githubusercontent.com/UmFzbXVz/podcasts/main/Politiken/docs/oversigt.json');
}
  
async function fetchradio4PodcastsData() {
  return fetchData('https://raw.githubusercontent.com/UmFzbXVz/podcasts/main/radio4/r4dio.json');
}

  
function clearSearch() {
    const searchInput = document.getElementById('searchInput');
    searchInput.value = '';
    resultsContainer.innerHTML = '';
    searchInput.focus();
}


function openModal(podcast) {
    const modal = document.getElementById('podcastModal');
    const descriptionElement = document.getElementById('modalDescription');
    descriptionElement.innerHTML = '';
    descriptionElement.classList.remove('expanded');
    modal.style.display = 'block';
    document.getElementById('modalTitle').textContent = podcast.text;
    document.getElementById('modalProvider').textContent = podcast.provider;
    descriptionElement.innerHTML = formatDescription(podcast.description);
    descriptionElement.classList.remove('expanded');

    document.getElementById('playOnSite').href = `https://umfzbxvz.github.io/podcasts/afspiller.html?rss=${encodeURIComponent(podcast.rssLink)}`;
    document.getElementById('playOnSite').target = '_blank';
    document.getElementById('visitWebsiteLink').href = podcast.url;
    document.getElementById('copyRSSButton').onclick = () => copyRSSLink(podcast.rssLink);
    document.getElementById('openInAppLink').href = `podcast://${podcast.rssLink}`;
}


function formatDescription(description) {
    let formattedDescription = description.replace(/\n/g, '<br>');
    formattedDescription = formattedDescription.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

    return formattedDescription;
}

function copyRSSLink(rssLink) {
    navigator.clipboard.writeText(rssLink).then(() => {
        showToast('RSS-link kopieret');
        document.getElementById('podcastModal').style.display = 'none';
    }).catch(err => {
        console.error('Failed to copy RSS link:', err);
    });
}

function getFormattedRSSUrl(podcastName) {
    const formattedPodcastName = encodeURIComponent(podcastName.replace(/\s/g, '_').toLowerCase() + '.rss');
    const firstCharacter = formattedPodcastName.charAt(0);
    const directory = isNaN(parseInt(firstCharacter)) ? firstCharacter.toUpperCase() : '0-9';
    return `https://raw.githubusercontent.com/UmFzbXVz/podcasts/main/${directory}/${formattedPodcastName}`;
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.classList.add('toast');
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

async function filterPodcasts(searchText) {
    if (searchText.length === 0) {
        resultsContainer.innerHTML = '';
        return;
    }

    if (searchText.length < 3) {
        resultsContainer.innerHTML = '<p>Indtast minimum 3 bogstaver for at søge</p>';
        return;
    }

    const results = [];
    const allData = [
        ...drPodcastsData.map(podcast => ({ text: podcast.name, provider: 'DR', description: podcast.description, url: podcast.program_url, image: podcast.image, rssLink: 'https://raw.githubusercontent.com/UmFzbXVz/DRSS/main/2.0/' + podcast.program_url.split('/').pop() + '.rss'})),
        ...podimoPodcastsData.map(podcast => ({ text: `${podcast.title}`, provider: 'Podimo', description: podcast.description, url: `https://podimo.com/dk/shows/${podcast.id}`, image: podcast.coverImageUrl, rssLink: `https://raw.githubusercontent.com/UmFzbXVz/podcasts/main/Podimo/RSS/${encodeURIComponent(podcast.title.replace(/[<>:"/\\|?*]/g, '_'))}.rss`})),
        ...Object.values(miscPodcastsData).map(podcast => ({ text: podcast.alt_text,provider: 'Radio24syv', description: podcast.description, url: podcast.url, image: podcast.image_url, rssLink: getFormattedRSSUrl(podcast.alt_text)})),
        ...radio4PodcastsData.map(podcast => ({ text: podcast.title, provider: 'Radio IIII', description: podcast.content, url: podcast.program_url, image: podcast.image_url, rssLink: podcast.program_url})),
        ...pir8dioPodcastsData.map(podcast => ({ text: podcast.title, provider: 'r8Dio', description: podcast.content, url: podcast.program_url, image: podcast.image, rssLink: `https://raw.githubusercontent.com/UmFzbXVz/pir8dio/main/${podcast.slug}.rss`})),
        ...politikenPodcastsData.map(podcast => ({ text: podcast.title, provider: 'Politiken', description: podcast.description, url: podcast.program_url, image: podcast.image, rssLink: `https://raw.githubusercontent.com/UmFzbXVz/podcasts/main/Politiken/RSS/${encodeURIComponent(podcast.id)}.rss`}))
    ];

    results.push(...allData.filter(podcast => podcast.text.toLowerCase().includes(searchText.toLowerCase())));

    displayResults(results);
}

const MAX_CACHE_ITEMS = 20;

function getLRUCache() {
    const cache = localStorage.getItem('imageCacheOrder');
    return cache ? JSON.parse(cache) : [];
}

function updateLRUCache(cacheKey) {
    let cacheOrder = getLRUCache();

    cacheOrder = cacheOrder.filter(key => key !== cacheKey);
    cacheOrder.push(cacheKey);

    if (cacheOrder.length > MAX_CACHE_ITEMS) {
        const oldestKey = cacheOrder.shift();
        localStorage.removeItem(oldestKey);
    }
    localStorage.setItem('imageCacheOrder', JSON.stringify(cacheOrder));
}

function loadImageToCache(url, cacheKey) {
    return new Promise((resolve, reject) => {
        const image = new Image();
        image.crossOrigin = 'Anonymous';

        image.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;
            const context = canvas.getContext('2d');
            context.drawImage(image, 0, 0, image.width, image.height);
            try {
                const dataURL = canvas.toDataURL('image/png');
                localStorage.setItem(cacheKey, dataURL);
                updateLRUCache(cacheKey);
                resolve(dataURL);
            } catch (error) {
                reject(error);
            }
        };
        image.onerror = (error) => reject(error);
        image.src = url;
    });
}

function isArchiveImage(url) {
    return url.includes('archive.org');
}

function cacheAndLoadImage(url, element) {
    const cacheKey = `cachedImage:${url}`;
    if (isArchiveImage(url)) {
        const cachedImage = localStorage.getItem(cacheKey);
        if (cachedImage) {
            element.src = cachedImage;
        } else {
            loadImageToCache(url, cacheKey)
                .then((cachedDataURL) => {
                    element.src = cachedDataURL;
                })
                .catch((error) => {
                    console.error('Failed to cache image:', error);
                    element.src = url;
                });
        }
    } else {
        element.src = url;
    }
}

function displayResults(results) {
    resultsContainer.innerHTML = '';
    if (results.length === 0) {
        resultsContainer.innerHTML = '<p>Ingen søgeresultater fundet</p>';
        return;
    }

    const grid = document.createElement('div');
    grid.classList.add('podcast-grid');

    results.forEach(result => {
        const card = document.createElement('div');
        card.classList.add('podcast-card');

        const img = document.createElement('img');
        img.alt = result.text;
        img.classList.add('podcast-cover');
        
        if (result.image) {
            cacheAndLoadImage(result.image, img);
        }

        const title = document.createElement('div');
        title.textContent = result.text;
        title.classList.add('podcast-title');

        card.appendChild(img);
        card.appendChild(title);
        card.addEventListener('click', () => openModal(result));
        grid.appendChild(card);
    });

    resultsContainer.appendChild(grid);
}

let debounceTimeout;
document.getElementById('searchInput').addEventListener('input', function () {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(() => {
        filterPodcasts(this.value.trim());
    }, 500);
});

document.getElementById('searchInput').addEventListener('keypress', function (event) {
    if (event.key === 'Enter') this.blur();
});
</script>
</body>
</html>
